<?xml version="1.0" encoding="UTF-8"?> 
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd"> 
 
<mapper namespace="citic.dxzp.ct.mapper.busi.Ct_yjmdMapper"> 
 <sql id="base_columns"> 
   file_code,file_name,file_path,file_size,md_type,create_dt,create_user,deal_dt,instructions,status_cd
 </sql> 
    
    
  <select id="selectCt_yjmd_fileByVo"  resultType="citic.dxzp.ct.domain.Ct_yjmd"> 
     select 
      <include refid="base_columns" /> 
      from ct_yjmd_upload 
      order by create_dt desc
  </select> 
  
  <select id="selectCt_yjmd_fileByStatus"  resultType="citic.dxzp.ct.domain.Ct_yjmd"> 
     select 
      <include refid="base_columns" /> 
      from ct_yjmd_upload 
      where status_cd = '0'
  </select> 
 
    <insert id="insertCt_yjmd_file" parameterType="citic.dxzp.risk.domain.Cgb_risk_case">
     insert into ct_yjmd_upload (<include refid="base_columns" />)
     values(
       #{file_code},#{file_name},#{file_path},#{file_size},#{md_type},#{create_dt},#{create_user},#{deal_dt},#{instructions},#{status_cd}
     )
  </insert>
  
  <!-- 查询个人黑名单 -->
  <select id="selectCt_yjmd_privateByVo" parameterType="citic.dxzp.ct.domain.Ct_yjmd_private"  resultType="citic.dxzp.ct.domain.Ct_yjmd_private" timeout="20"> 
     select *  from ct_yjmd_private  where 1=1
     <if test="cust_name != null  and cust_name != '' "> 
        and cust_name like '%'||#{cust_name}||'%'
      </if>
       <if test="cert_type != null  and cert_type != '' "> 
        and cert_type=#{cert_type}
      </if>
       <if test="cert_num != null  and cert_num != '' "> 
        and cert_num=#{cert_num}
      </if>
      order by cert_num
      with ur
  </select>
  <!-- 查询对公黑名单 -->
  <select id="selectCt_yjmd_publicByVo" parameterType="citic.dxzp.ct.domain.Ct_yjmd_public"  resultType="citic.dxzp.ct.domain.Ct_yjmd_public" timeout="15"> 
     select * from ct_yjmd_public  where 1=1  
      <if test="cust_name != null  and cust_name != '' "> 
        and cust_name like '%'||#{cust_name}||'%'
      </if> 
      <if test="card_code != null  and card_code != '' "> 
        and card_code=#{card_code}
      </if>
      <if test="data_month_start != null and data_month_start !=''">
           and     data_month &gt;=#{data_month_start}    
      </if>
      <if test="data_month_end != null and data_month_end !=''">
            and  data_month &lt;=#{data_month_end}      
      </if>
      order by cust_name
      with ur   
  </select>
  
   <!-- 名单接口PERSON-->
   <select id="selectCt_yjmd_responseByPerson" parameterType="citic.dxzp.ct.domain.Ct_yjmd_request"  resultType="citic.dxzp.ct.domain.Ct_yjmd_response"> 
     select
     serialno as recordid,cert_type as certtype,cert_num as certid,cust_name as customername,cust_addr as address,deflt_type as duetype,deflt_day as duedays,data_month as occurtime,'01' as customertype,valid_date
     from ct_yjmd_private
     where cert_type = #{certtype} and cert_num = #{certid}
      and cust_name = #{customername}
      with ur
  </select>
  
  <!-- 名单接口UNIT-->
   <select id="selectCt_yjmd_responseByUnit" parameterType="citic.dxzp.ct.domain.Ct_yjmd_request"  resultType="citic.dxzp.ct.domain.Ct_yjmd_response"> 
    select
    serialno as recordid,card_code as certid,cust_name  as customername,cust_reg_addr as address,deflt_type as duetype,deflt_day as duedays,data_month as occurtime,'02' as customertype,valid_date
    from ct_yjmd_public
    where cust_name = #{customername}
    with ur
  </select>
  
    <!-- 访问日志 -->
   <insert id="insertCt_request_log" parameterType="citic.dxzp.ct.domain.Ct_request_log">
     insert into ct_request_log (sys_code,trans_code,query_time,query_condition,remark)
     values(
       #{sys_code},#{trans_code},#{query_time},#{query_condition},#{remark}
     )
  </insert>
  
  <!-- 更新zip处理状态 -->
   <update id="updateCt_yjmd_upload" parameterType="citic.dxzp.ct.domain.Ct_yjmd">
         update ct_yjmd_upload set status_cd=#{status_cd},instructions=#{instructions},deal_dt=#{deal_dt}
         where file_code = #{file_code}
   </update>
   
   <!-- 更新个人黑名单     数据量大,设置超时为60秒-->
   <update id="updateCt_yjmd_private" parameterType="citic.dxzp.ct.domain.Ct_yjmd" timeout="600">
         MERGE INTO CT_YJMD_PRIVATE T    
USING (
    SELECT * FROM (
 SELECT    SERIALNO                            , 
          CERT_TYPE                             , 
           CERT_NUM                              , 
           CUST_NAME                             , 
           CUST_ADDR                             , 
           DEFLT_TYPE                            , 
           DEFLT_DAY                             , 
           CUST_ZONE                             , 
           DATA_MONTH                         ,
           VALID_DATE                             ,
           ROW_NUMBER() OVER (PARTITION BY CERT_TYPE , CERT_NUM, CUST_NAME ORDER BY SERIALNO  DESC)   ROW_NUM
FROM TMP_CT_YJMD_PRIVATE) T WHERE ROW_NUM = 1    
)   AS S
     ON (T.CERT_TYPE = S.CERT_TYPE                
     AND T.CERT_NUM  = S.CERT_NUM                 
     AND T.CUST_NAME = S.CUST_NAME   
     )  
     WHEN MATCHED THEN
     UPDATE
     SET   T.SERIALNO   = S.SERIALNO             , 
           T.CERT_TYPE  = S.CERT_TYPE            , 
           T.CERT_NUM   = S.CERT_NUM             , 
           T.CUST_NAME  = S.CUST_NAME            , 
           T.CUST_ADDR  = S.CUST_ADDR            , 
           T.DEFLT_TYPE = S.DEFLT_TYPE           , 
           T.DEFLT_DAY  = S.DEFLT_DAY            , 
           T.CUST_ZONE  = S.CUST_ZONE            , 
           T.DATA_MONTH = S.DATA_MONTH           ,
           T.VALID_DATE = S.VALID_DATE  
     WHEN NOT  MATCHED THEN 
     INSERT                
     (     T.SERIALNO                            , 
           T.CERT_TYPE                           , 
           T.CERT_NUM                            , 
           T.CUST_NAME                           , 
           T.CUST_ADDR                           , 
           T.DEFLT_TYPE                          , 
           T.DEFLT_DAY                           , 
           T.CUST_ZONE                           , 
           T.DATA_MONTH                          ,
           T.VALID_DATE  
            )                           
     VALUES     
     (     S.SERIALNO                            , 
           S.CERT_TYPE                           , 
           S.CERT_NUM                            , 
           S.CUST_NAME                           , 
           S.CUST_ADDR                           , 
           S.DEFLT_TYPE                          , 
           S.DEFLT_DAY                           , 
           S.CUST_ZONE                           , 
           S.DATA_MONTH                          ,
           S.VALID_DATE  
   )
   </update>
   
   <!-- 更新单位黑名单  数据量大,设置超时为60秒-->
   <update id="updateCt_yjmd_public" parameterType="citic.dxzp.ct.domain.Ct_yjmd" timeout="600">
        MERGE INTO CT_YJMD_PUBLIC T                  
USING (
   SELECT * FROM (
 SELECT    SERIALNO                            , 
           CARD_CODE                           , 
           CUST_NAME                           , 
           CUST_REG_ADDR                       , 
           DEFLT_TYPE                          , 
           DEFLT_DAY                           , 
           CUST_ZONE                           , 
           DATA_MONTH                          ,
           VALID_DATE                          ,
           ROW_NUMBER() OVER (PARTITION BY  CUST_NAME ORDER BY SERIALNO  DESC)  ROW_NUM
FROM TMP_CT_YJMD_PUBLIC) T WHERE ROW_NUM = 1                  
)   AS S                                       
     ON ( TRIM(T.CUST_NAME) = TRIM(S.CUST_NAME)   
     )  
     WHEN MATCHED THEN
     UPDATE
     SET   T.SERIALNO      = S.SERIALNO         ,
           T.CARD_CODE     = S.CARD_CODE        ,
           T.CUST_NAME     = S.CUST_NAME        ,
           T.CUST_REG_ADDR = S.CUST_REG_ADDR    ,
           T.DEFLT_TYPE    = S.DEFLT_TYPE       ,
           T.DEFLT_DAY     = S.DEFLT_DAY        ,
           T.CUST_ZONE     = S.CUST_ZONE        ,
           T.DATA_MONTH    = S.DATA_MONTH       ,
           T.VALID_DATE    = S.VALID_DATE  
                                                
     WHEN NOT  MATCHED THEN                     
     INSERT                                     
     (     T.SERIALNO                           ,
           T.CARD_CODE                          ,
           T.CUST_NAME                          ,
           T.CUST_REG_ADDR                      ,
           T.DEFLT_TYPE                         ,
           T.DEFLT_DAY                          ,
           T.CUST_ZONE                          ,
           T.DATA_MONTH                         ,  
           T.VALID_DATE 
            )                           
     VALUES     
     (     S.SERIALNO                           ,
           S.CARD_CODE                          ,
           S.CUST_NAME                          ,
           S.CUST_REG_ADDR                      ,
           S.DEFLT_TYPE                         ,
           S.DEFLT_DAY                          ,
           S.CUST_ZONE                          ,
           S.DATA_MONTH                         ,
           S.VALID_DATE 
      )
   </update>
   
   <!-- 清空个人黑名单临时表 -->
   <update id="updateTmp_ct_yjmd_private" parameterType="citic.dxzp.ct.domain.Ct_yjmd">
         truncate table tmp_ct_yjmd_private immediate
   </update>
   
   <!-- 清空单位黑名单临时表 -->
   <update id="updateTmp_ct_yjmd_public" parameterType="citic.dxzp.ct.domain.Ct_yjmd">
         truncate table tmp_ct_yjmd_public immediate
   </update>
</mapper> 
