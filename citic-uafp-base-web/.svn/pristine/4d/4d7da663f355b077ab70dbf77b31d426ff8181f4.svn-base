<?xml version="1.0" encoding="UTF-8"?> 
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="citic.cgb.xmlmsg.mapper.busi.Afp007DtoMapper">

	<!-- AFP007扣划信息查询 -->
	<select id="selectKHInfoByInterface" parameterType="citic.cgb.xmlmsg.domain.Afp007Dto" resultType="citic.cgb.xmlmsg.domain.Afp007QueryDto">
		select
		a.bdhm,a.ccxh,c.xm,c.zjlx,c.dsrzjhm,c.fymc,c.fydm,c.cbr,c.yhdh,c.ah,c.gzzbh,c.gwzbh,c.lxfs,a.khzh,a.glzhhm,a.khwd,a.khwddm,a.bz,a.je,a.sfjh,a.ckwh,a.zxkzhhm,a.zxkzhkhh,a.zxkzhkhhhh,a.zxkzhzh,a.zxkzhlx,a.ydjah,a.ydjdh
		,a.zhlx,a.jjyy as wnkzyy,a.status,c.recipient_time
		from br31_kzzh a left join br31_kzqq c on a.bdhm = c.bdhm
		where a.kzcs='06' and a.status in ('N','F')
		<if test="bdhm != null  and bdhm != '' ">
			and a.bdhm like #{bdhm}||'%'
		</if>
		<if test="khzh != null  and khzh != '' ">
			and (a.khzh like #{khzh}||'%' or a.glzhhm like #{khzh}||'%')
		</if>
		<if test="bz != null  and bz != '' ">
			and a.bz = #{bz}
		</if>
		<if test="sfjh != null  and sfjh != '' ">
			and a.sfjh = #{sfjh}
		</if>
		<if test="ckwh != null  and ckwh != '' ">
			and a.ckwh like #{ckwh}||'%'
		</if>
		<if test="status != null  and status != '' ">
			and a.status = #{status}
		</if>
		<if test="xm != null  and xm != '' ">
			and c.xm like #{xm}||'%'
		</if>
		<if test="zjlx != null  and zjlx != '' ">
			and c.zjlx = #{zjlx}
		</if>
		<if test="dsrzjhm != null  and dsrzjhm != '' ">
			and c.dsrzjhm like #{dsrzjhm}||'%'
		</if>
		<if test="fydm != null  and fydm != '' ">
			and c.fydm like #{fydm}||'%'
		</if>
		<if test="fymc != null  and fymc != '' ">
			and c.fymc like #{fymc}||'%'
		</if>
		<if test="begindate != null  and begindate != '' ">
			and c.recipient_time &gt;= #{begindate}
		</if>
		<if test="enddate != null  and enddate != '' ">
			and c.recipient_time &lt;= #{enddate}
		</if>
		order by recipient_time,bdhm
	</select>

	<!-- AFP010控制信息查询/AFP012导出 -->
	<select id="selectKZInfoByInterface" parameterType="citic.cgb.xmlmsg.domain.Afp010Dto" resultType="citic.cgb.xmlmsg.domain.Afp007QueryDto">
		select
		a.bdhm,a.ccxh,a.kzlx,c.xm,c.zjlx,c.dsrzjhm,c.fymc,c.fydm,c.cbr,c.yhdh,c.ah,c.gzzbh,c.gwzbh,c.lxfs,c.recipient_time,a.khzh,a.glzhhm,a.khwd,a.khwddm,a.kznr,a.ksrq,a.jsrq,a.bz,a.je,a.sfjh,
		a.ckwh,a.zxkzhhm,a.zxkzhkhh,a.zxkzhkhhhh,a.zxkzhzh,a.zxkzhlx,a.ydjah,a.ydjdh,a.zhlx,a.jjyy as wnkzyy,a.status,a.kzcs,a.zcmc,a.zclx,a.cpxszl,a.dqh,a.jrcpbh,a.lczh,a.zjhkzh,a.se,a.jldw
		from br31_kzzh a left join br31_kzqq c on a.bdhm = c.bdhm
		where   a.status is not null and  a.status !=''
		<if test="kzcs != null  and kzcs != '' ">
			and a.kzcs = #{kzcs}
		</if>
		<if test="bdhm != null  and bdhm != '' ">
			and a.bdhm like #{bdhm}||'%'
		</if>
		<if test="khzh != null  and khzh != '' ">
			and (a.khzh like #{khzh}||'%' or a.glzhhm like #{khzh}||'%')
		</if>
		<if test="bz != null  and bz != '' ">
			and a.bz = #{bz}
		</if>
		<if test="sfjh != null  and sfjh != '' ">
			and a.sfjh = #{sfjh}
		</if>
		<if test="khhfhh != null  and khhfhh != '' ">
			and a.khhfhh = #{khhfhh}
		</if>
		<if test="khhsh != null  and khhsh != '' ">
			and a.khhsh = #{khhsh}
		</if>
		<if test="ckwh != null  and ckwh != '' ">
			and a.ckwh like #{ckwh}||'%'
		</if>
		<if test="status != null  and status != '' ">
			and a.status = #{status}
		</if>
		<if test="je != null  and je != '' ">
			and a.je = #{je}
		</if>
		<if test="kzlx != null  and kzlx != '' ">
			and a.kzlx = #{kzlx}
		</if>
		<if test="xm != null  and xm != '' ">
			and c.xm like #{xm}||'%'
		</if>
		<if test="zjlx != null  and zjlx != '' ">
			and c.zjlx = #{zjlx}
		</if>
		<if test="dsrzjhm != null  and dsrzjhm != '' ">
			and c.dsrzjhm like #{dsrzjhm}||'%'
		</if>
		<if test="fydm != null  and fydm != '' ">
			and c.fydm like #{fydm}||'%'
		</if>
		<if test="fymc != null  and fymc != '' ">
			and c.fymc like #{fymc}||'%'
		</if>
		<if test="begindate != null  and begindate != '' ">
			and c.recipient_time &gt;= #{begindate}
		</if>
		<if test="enddate != null  and enddate != '' ">
			and c.recipient_time &lt;= #{enddate}
		</if>
		order by recipient_time,bdhm
	</select>

	<!-- AFP008扣划信息查询 -->
	<update id="updateBr31_kzzhByInterface" parameterType="citic.cgb.xmlmsg.domain.Afp008Dto">
		update br31_kzzh
		set status = #{dealstatus}
		<if test="sxzh != null">
			,sxzh = #{sxzh}
		</if>
		<if test="sxzhmc != null">
			,sxzhmc = #{sxzhmc}
		</if>
		<if test="sxzhkhhh != null">
			,sxzhkhhh = #{sxzhkhhh}
		</if>
		<if test="sxzhkhhmc != null">
			,sxzhkhhmc = #{sxzhkhhmc}
		</if>
		<if test="userid != null">
			,userid=#{userid}
		</if>
		<if test="checkuserid != null">
			,checkuserid=#{checkuserid}
		</if>
		<if test="dealstatus =='R'.toString()">
			,jjyy=#{wnkzyy}
		</if>
		where bdhm = #{bdhm} and ccxh = #{xh}
	</update>
	<update id="updateBr31_kzcl_infoByInterface" parameterType="citic.cgb.xmlmsg.domain.Afp008Dto">
		update br31_kzcl_info
		set dealing_time=#{dealing_time},beiz=#{beiz},wnkzyy = #{wnkzyy}
		<if test="dealstatus =='S'.toString()">
			,skje=#{skje}
		</if>
		where bdhm = #{bdhm} and ccxh = #{xh}
	</update>
	<insert id="insertMc21_task_fact2ByInterface" parameterType="citic.cgb.xmlmsg.domain.Afp008Dto">
		insert  into mc21_task_fact2(taskid,subtaskid,tasktype,datatime,serverid,bdhm,taskobj,freq,taskname,tgroupid,taskcmd,isdyna,taskkey)
		(
		select taskid,subtaskid,tasktype,#{datatime},#{serverid},bdhm,taskobj,freq,taskname,tgroupid,taskcmd,isdyna,#{taskkey}
		from mc21_task_fact2 where tasktype = '1' and bdhm= #{bdhm} 
		FETCH FIRST 1 ROWS ONLY
		)
	</insert>
	<!-- AFP009附件路径- -->
	<select id="selectWsInfoByInterface" parameterType="citic.cgb.xmlmsg.domain.Afp009Dto" resultType="citic.cgb.xmlmsg.domain.AFP009AttachDto">
		select bdhm,xh,wjmc as filename,wjlx as filetype,wspath as filepath
		from br31_ws
		where bdhm =
		#{bdhm}
	</select>
	<select id="selectGzzInfoByInterface" parameterType="citic.cgb.xmlmsg.domain.Afp009Dto" resultType="citic.cgb.xmlmsg.domain.AFP009AttachDto">
		select bdhm,xh,zjmc as filename,(case when gzzwjgs!=''then gzzwjgs else gwzwjgs end) as
		filetype,(case when gzzpath!=''then gzzpath else gwzpath end) as filepath
		from br31_gzz
		where bdhm = #{bdhm}
	</select>
	<select id="selectHzwsInfoByInterface" parameterType="citic.cgb.xmlmsg.domain.Afp009Dto" resultType="citic.cgb.xmlmsg.domain.AFP009AttachDto">
		select bdhm,xh,wjmc as filename,wjlx as filetype,wjpath as filepath
		from br31_kzqq_hzws
		where
		bdhm = #{bdhm}
	</select>

</mapper> 
